# ADL v0.3 Concurrency: Failure, Cancellation, Replay (Design)

Issue: #239  
Epic: #108  
Burst: #235

## Failure Semantics

Branch-level result is always one of:
- `success`
- `failure`
- `cancelled`

### Branch Failure

- A branch failure records `StepFinished(branch_step_id, failure)` deterministically.
- Failure does not reorder already-emitted branch events.

### Join Failure Policy (v0.3)

Default join policy for v0.3:
- `join_policy = fail_on_any_failure`

Behavior:
- If any required branch is `failure`, join result is `failure`.
- Join still emits deterministic terminal events:
  - `JoinStarted(join_step_id)`
  - `JoinFinished(join_step_id, failure)`

## Cancellation Semantics

Cancellation in v0.3 is deterministic and explicit:

1. Cancellation source is recorded (`manual`, `parent_failure`, `policy`).
2. Non-terminal branches transition to `cancelled` in deterministic branch-key order.
3. Each cancelled branch emits deterministic terminal event:
- `StepFinished(branch_step_id, cancelled)`

Propagation rule:
- With default join policy, one failed required branch may trigger cancellation of unfinished sibling branches.

## Replay Rules

Given identical inputs, runtime version, and document:

- Planned concurrent structure is identical.
- Step ids are identical.
- Trace event sequence order is identical.
- Terminal outcomes are equivalent up to deterministic failure/cancellation policy.

Replay identity tuple:
- `(doc_hash, inputs_hash, runtime_semver, policy_version)`

If tuple changes, replay-equivalence is not guaranteed.

## Edge Cases

- Branches with zero model calls still emit start/finish events.
- Join with zero required branches is invalid in v0.3 (schema/runtime validation failure).
- Cancellation after branch terminal state is a no-op.

## v0.3 Non-goals

- User-defined join failure policies beyond `fail_on_any_failure`.
- Time-based speculative branch racing.
- Retries with non-deterministic backoff.
