# ADL v0.3 Concurrency Test Matrix (Design Plan)

Issue: #241  
Epic: #108  
Burst: #235

## Goal
Define a concrete, file-level test plan for deterministic fork/join semantics before runtime implementation.

## Unit Tests

1. Deterministic branch ordering in planner
- File to add: `swarm/tests/plan_concurrency_tests.rs`
- Cases:
  - Branch keys sorted lexically
  - Deterministic step-id derivation for branch/join nodes

2. Deterministic event ordering tie-breakers
- File to add: `swarm/tests/trace_concurrency_tests.rs`
- Cases:
  - Event order follows `(step_id, event_kind_rank)` tie-break
  - Stable output for repeated identical runs

3. Join conflict policy behavior
- File to add: `swarm/tests/execute_concurrency_tests.rs`
- Cases:
  - `fail_on_any_failure` join policy
  - `fail_on_conflict` state materialization behavior

## Integration Tests

1. End-to-end fork/join dry-run trace shape
- File to add: `swarm/tests/concurrency_integration_tests.rs`
- Fixture to add: `swarm/tests/fixtures/v0-3-concurrency-fork-join.adl.yaml`
- Assertions:
  - Fork/branch/join deterministic event order
  - Deterministic terminal join result

2. Cancellation propagation
- File to add: `swarm/tests/concurrency_integration_tests.rs`
- Fixture to add: `swarm/tests/fixtures/v0-3-concurrency-cancel-on-failure.adl.yaml`
- Assertions:
  - Unfinished sibling branches become `cancelled` in sorted branch order

3. Replay equivalence
- File to add: `swarm/tests/concurrency_integration_tests.rs`
- Assertions:
  - Same fixture + same inputs => same plan + same trace ordering

## Existing Test Files To Extend

- `swarm/tests/trace_tests.rs`
- `swarm/tests/execute_tests.rs`
- `swarm/tests/resolve_tests.rs`

## Non-goals for This Burst

- Implementing concurrency runtime paths.
- Introducing non-deterministic performance-oriented scheduling.
